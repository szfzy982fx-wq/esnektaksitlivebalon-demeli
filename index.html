<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profesyonel Emlak Analizi v4</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #2980b9;
            --light: #f4f6f7;
            --green: #27ae60;
            --red: #c0392b;
            --orange: #e67e22;
        }
        body { font-family: 'Segoe UI', sans-serif; background: #eef2f3; padding: 20px; color: #333; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        h1 { text-align: center; color: var(--primary); border-bottom: 3px solid var(--accent); padding-bottom: 15px; margin-bottom: 25px; }
        
        .row { display: flex; gap: 20px; flex-wrap: wrap; }
        .col { flex: 1; min-width: 280px; }
        
        label { display: block; margin: 12px 0 5px; font-weight: 600; color: var(--primary); font-size: 0.95rem; }
        input { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 1.1rem; box-sizing: border-box; font-weight: bold; font-family: monospace; color: #444; }
        input:focus { border-color: var(--accent); outline: none; background: #fbfdff; }
        
        /* Taksit Alanı */
        .installment-box { background: var(--light); padding: 20px; border-radius: 8px; margin-top: 15px; border: 1px dashed #bdc3c7; }
        .inst-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        
        /* Butonlar */
        .btn { width: 100%; padding: 14px; border: none; border-radius: 6px; cursor: pointer; font-size: 1.1rem; font-weight: bold; margin-top: 15px; transition: 0.2s; }
        .btn-add { background: #95a5a6; color: white; font-size: 0.9rem; padding: 10px; }
        .btn-calc { background: var(--primary); color: white; margin-top: 25px; }
        .btn-calc:hover { background: #34495e; }
        .btn-del { background: #e74c3c; color: white; width: auto; padding: 0 15px; height: 46px; border-radius: 6px; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; }

        /* Sonuç Alanı */
        .result-box { margin-top: 25px; padding: 25px; border-radius: 10px; background: #fff; border: 2px solid var(--accent); display: none; }
        .res-row { display: flex; justify-content: space-between; margin-bottom: 12px; border-bottom: 1px solid #f0f0f0; padding-bottom: 8px; font-size: 1.05rem; }
        .res-row:last-child { border: none; }
        .balloon { color: var(--orange); font-size: 1.3rem; font-weight: 800; }
        
        .info-tag { font-size: 0.85rem; padding: 4px 8px; border-radius: 4px; display: inline-block; margin-left: 10px; vertical-align: middle; }
        .tag-interest { background: #fef5e7; color: #d35400; border: 1px solid #f5c6cb; }
        .tag-normal { background: #e8f8f5; color: #27ae60; border: 1px solid #d4efdf; }

        .verdict { text-align: center; padding: 15px; color: white; font-weight: bold; margin-top: 20px; border-radius: 8px; font-size: 1.2rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .v-green { background: var(--green); }
        .v-red { background: var(--red); }
    </style>
</head>
<body>

<div class="container">
    <h1>Gayrimenkul Yatırım Analizi v4</h1>

    <div class="row">
        <div class="col">
            <label>Liste Fiyatı (Vade Farksız/Orijinal)</label>
            <input type="text" id="listPrice" onkeyup="fmt(this)" placeholder="Örn: 6.037.000">
            
            <label>Peşinat Tutarı</label>
            <input type="text" id="downPayment" onkeyup="fmt(this)" placeholder="Örn: 3.018.500">

            <label>Mevduat Faizi (Yıllık %)</label>
            <input type="number" id="depositInterest" value="45">
        </div>
        <div class="col">
            <label>Toplam Vade Süresi (Ay)</label>
            <input type="number" id="totalMonths" value="60">

            <label>Peşin Alım İndirimi (%)</label>
            <input type="number" id="discount" value="15">
        </div>
    </div>

    <div class="installment-box" id="instContainer">
        <label style="margin-top:0; border-bottom:1px solid #ddd; padding-bottom:5px; margin-bottom:10px;">Taksit Planı</label>
        </div>
    <button class="btn btn-add" onclick="addRow()">+ Yeni Taksit Dönemi Ekle</button>

    <button class="btn btn-calc" onclick="calculate()">HESAPLA VE KARŞILAŞTIR</button>

    <div class="result-box" id="results">
        <h3 style="text-align:center; margin-top:0; color:var(--primary)">Finansal Analiz Sonucu</h3>
        
        <div class="res-row">
            <span>Toplam Geri Ödeme (Vade Farkı Dahil):</span> 
            <div>
                <strong id="outTotalPaid"></strong>
                <span id="interestTag"></span>
            </div>
        </div>
        
        <div class="res-row" style="background:#fff8f0; border:none; padding:10px; border-radius:6px; margin-top:5px;">
            <span style="color:#d35400; font-weight:bold;">Varsa Kalan Balon Ödeme:</span> 
            <strong class="balloon" id="outBalloon">0 ₺</strong>
        </div>

        <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">

        <div class="res-row">
            <span>Vadeli Planın Bugünkü Değeri (NPV):</span> 
            <strong id="outNPV" style="font-size:1.2rem; color:var(--primary)"></strong>
        </div>
        <div class="res-row">
            <span>İndirimli Peşin Fiyat:</span> 
            <strong id="outCash" style="font-size:1.2rem; color:var(--green)"></strong>
        </div>
        
        <div style="text-align:center; margin-top:20px;">
            <small style="color:#777; font-weight:600;">BAŞABAŞ OLMASI GEREKEN İNDİRİM</small><br>
            <span id="outBreak" style="font-size:2rem; font-weight:bold; color:var(--accent)"></span>
        </div>

        <div id="verdict" class="verdict"></div>
        <p style="text-align:center; font-size:0.9rem; color:#666; margin-top:10px;">
            (NPV, taksitlerin mevduat getirisi düşüldükten sonraki reel maliyetidir.)
        </p>
    </div>
</div>

<script>
    const tr = new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY', maximumFractionDigits: 0 });

    function fmt(el) {
        let v = el.value.replace(/\D/g, "");
        if(!v) { el.value = ""; return; }
        el.value = v.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

    function getNum(val) { return parseFloat(val.replace(/\./g, '')) || 0; }

    // Taksit satırı ekleme
    function addRow(dur=60, amt="") {
        const div = document.createElement('div');
        div.className = 'inst-row';
        div.innerHTML = `
            <div style="flex:1">
                <input type="number" class="dur" value="${dur}" placeholder="Ay">
            </div>
            <div style="flex:2">
                <input type="text" class="amt" value="${amt}" onkeyup="fmt(this)" placeholder="Aylık Tutar (TL)">
            </div>
            <button class="btn btn-del" onclick="this.parentElement.remove()">×</button>
        `;
        document.getElementById('instContainer').appendChild(div);
    }

    function calculate() {
        // Girdileri Al
        const listPrice = getNum(document.getElementById('listPrice').value);
        const downPayment = getNum(document.getElementById('downPayment').value);
        const totalMonths = parseInt(document.getElementById('totalMonths').value) || 1;
        const depRate = parseFloat(document.getElementById('depositInterest').value) / 100 / 12; // Aylık Net Faiz
        const discount = parseFloat(document.getElementById('discount').value);

        if(listPrice === 0) { alert("Lütfen Liste Fiyatını Giriniz."); return; }

        // Taksit Akışını Hesapla
        let totalInstPaid = 0;
        let flow = [];
        document.querySelectorAll('.inst-row').forEach(row => {
            const d = parseInt(row.querySelector('.dur').value) || 0;
            const a = getNum(row.querySelector('.amt').value);
            for(let i=0; i<d; i++) {
                if(flow.length < totalMonths) {
                    flow.push(a);
                    totalInstPaid += a;
                }
            }
        });

        // Toplam Ödeme (Peşinat + Taksitler)
        const grandTotal = downPayment + totalInstPaid;

        // Vade Farkı Kontrolü ve Etiketleme
        const interestTag = document.getElementById('interestTag');
        if (grandTotal > listPrice) {
            interestTag.className = "info-tag tag-interest";
            interestTag.innerText = "⚠️ Vade Farkı İçeriyor";
        } else {
            interestTag.className = "info-tag tag-normal";
            interestTag.innerText = "✅ Faizsiz / Sıfır Faiz";
        }

        // Balon Ödeme Hesabı
        // Mantık: Eğer (Peşinat + Taksitler) < Liste Fiyatı ise, kalanı balon ödemedir.
        // Eğer (Peşinat + Taksitler) > Liste Fiyatı ise, balon yoktur (zaten fazlası ödenmiştir).
        let balloon = 0;
        if (grandTotal < listPrice) {
            balloon = listPrice - grandTotal;
        } 
        // Not: Faizli senaryoda grandTotal > listPrice olacağı için balloon 0 kalır, bu doğrudur.

        // NPV (Net Bugünkü Değer) Hesapla
        let npv = downPayment;
        
        // Taksitlerin İskontosu
        for(let i=0; i<flow.length; i++) {
            if(flow[i] > 0) npv += flow[i] / Math.pow(1 + depRate, i + 1);
        }
        
        // Varsa Balonun İskontosu (Vade Sonu + 1 Ay)
        if(balloon > 0) {
            npv += balloon / Math.pow(1 + depRate, totalMonths + 1);
        }

        // SONUÇLAR
        const cashPrice = listPrice * (1 - (discount/100));
        const breakEven = (1 - (npv / listPrice)) * 100;

        document.getElementById('results').style.display = 'block';
        document.getElementById('outTotalPaid').innerText = tr.format(grandTotal);
        document.getElementById('outBalloon').innerText = tr.format(balloon);
        document.getElementById('outNPV').innerText = tr.format(npv);
        document.getElementById('outCash').innerText = tr.format(cashPrice);
        document.getElementById('outBreak').innerText = "% " + breakEven.toFixed(2);

        const v = document.getElementById('verdict');
        if(cashPrice > npv) { // Eğer Peşin Fiyat, Vadeli Maliyetten (NPV) büyükse -> Vadeli Al
            v.className = "verdict v-green";
            v.innerHTML = "TAVSİYE: VADELİ ALIN! <br> <span style='font-size:0.9rem; font-weight:normal'>(Paranızı bankada tutmak daha karlı)</span>";
        } else {
            v.className = "verdict v-red";
            v.innerHTML = "TAVSİYE: PEŞİN ALIN! <br> <span style='font-size:0.9rem; font-weight:normal'>(İndirim oranı faiz getirisinden daha yüksek)</span>";
        }
    }

    // Açılışta örnek veri (Sizin örneğinizdeki U Blok)
    window.onload = function() {
        document.getElementById('listPrice').value = "6.037.000"; // Gerçek Liste Fiyatı
        document.getElementById('downPayment').value = "3.018.500";
        document.getElementById('totalMonths').value = "60";
        
        // Temizle ve ekle
        document.getElementById('instContainer').innerHTML = '<label style="margin-top:0; border-bottom:1px solid #ddd; padding-bottom:5px; margin-bottom:10px;">Taksit Planı</label>';
        addRow(60, "66.961"); 
    };
</script>

</body>
</html>
